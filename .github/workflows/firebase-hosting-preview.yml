name: Deploy Hosting (Preview)

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  preview-hosting:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout mã nguồn
        uses: actions/checkout@v4

      - name: Thiết lập Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cài dependencies
        run: npm ci

      - name: Kiểm tra data contract
        run: npm run validate:data

      - name: Cài Firebase CLI
        run: npm install -g firebase-tools@13

      - name: Thiết lập xác thực Firebase
        shell: bash
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          if [ -n "${FIREBASE_SERVICE_ACCOUNT}" ]; then
            echo "${FIREBASE_SERVICE_ACCOUNT}" > "${RUNNER_TEMP}/firebase-sa.json"
            echo "GOOGLE_APPLICATION_CREDENTIALS=${RUNNER_TEMP}/firebase-sa.json" >> "${GITHUB_ENV}"
            echo "FIREBASE_AUTH_MODE=service-account" >> "${GITHUB_ENV}"
          elif [ -n "${FIREBASE_TOKEN}" ]; then
            echo "FIREBASE_AUTH_MODE=token" >> "${GITHUB_ENV}"
          else
            echo "Thiếu FIREBASE_SERVICE_ACCOUNT hoặc FIREBASE_TOKEN" >&2
            exit 1
          fi

      - name: Deploy Hosting preview
        shell: bash
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          CHANNEL_ID="pr-${{ github.event.number }}"
          if [ "${FIREBASE_AUTH_MODE}" = "token" ]; then
            firebase hosting:channel:deploy "${CHANNEL_ID}" --expires 7d --token "${FIREBASE_TOKEN}"
          else
            firebase hosting:channel:deploy "${CHANNEL_ID}" --expires 7d
          fi
