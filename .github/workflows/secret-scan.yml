name: QuÃ©t bÃ­ máº­t

on:
  pull_request:
  push:

permissions:
  contents: read

jobs:
  secret_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (PR)
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Checkout (push)
        if: github.event_name != 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Đảm bảo commit before tồn tại
        if: github.event_name == 'push'
        shell: bash
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          if [ -n "${BEFORE}" ] && ! git cat-file -e "${BEFORE}^{commit}" 2>/dev/null; then
            git fetch --no-tags --prune --depth=0 origin "${BEFORE}"
          fi
      - name: Kiểm tra file ignore tồn tại
        run: |
          test -f .gitleaksignore
          sed -n '1,200p' .gitleaksignore
      - name: Cài gitleaks CLI (v8.24.3)
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL -o /tmp/gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.24.3/gitleaks_8.24.3_linux_x64.tar.gz
          tar -xzf /tmp/gitleaks.tar.gz -C /tmp gitleaks
          sudo mv /tmp/gitleaks /usr/local/bin/gitleaks
          gitleaks version
      - name: Quét bí mật bằng gitleaks (fallback nếu thiếu commit)
        shell: bash
        run: |
          set -euo pipefail
          RANGE=""
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
            if [ -n "${BASE}" ] && [ -n "${HEAD}" ]; then
              if git cat-file -e "${BASE}^{commit}" 2>/dev/null && git cat-file -e "${HEAD}^{commit}" 2>/dev/null; then
                RANGE="${BASE}..${HEAD}"
              fi
            fi
          else
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"
            if [ -n "${BEFORE}" ] && [ "${BEFORE}" != "0000000000000000000000000000000000000000" ]; then
              if git cat-file -e "${BEFORE}^{commit}" 2>/dev/null && git cat-file -e "${AFTER}^{commit}" 2>/dev/null; then
                RANGE="${BEFORE}..${AFTER}"
              fi
            fi
          fi
          code=0
          if [ -n "${RANGE}" ]; then
            gitleaks detect --redact --gitleaks-ignore-path=.gitleaksignore --log-level=info --log-opts="${RANGE}" || code=$?
          else
            gitleaks detect --redact --gitleaks-ignore-path=.gitleaksignore --log-level=info || code=$?
          fi
          if [ "${code}" = "2" ]; then
            echo "Phát hiện bí mật, dừng workflow."
            exit 2
          elif [ "${code}" != "0" ]; then
            echo "Gitleaks lỗi hạ tầng (code=${code})."
            exit "${code}"
          fi
