<!DOCTYPE html>
<html lang="vi" data-world="origami">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Trung tâm tài khoản</title>
  <link rel="stylesheet" href="assets/dist/tailwind.css">
  <link rel="stylesheet" href="./assets/tones.css">
  <link rel="stylesheet" href="./assets/site_base.css">
  <link rel="stylesheet" href="./assets/topbar_overrides.css">
  <style>
    #portalMenu[data-open="0"],
    #worldMenu[data-open="0"]{ display: none; }
    .tc-menu-item{
      color: var(--text);
      transition: background-color .15s ease, transform .05s ease;
    }
    .tc-menu-item:hover{ background: rgba(255,255,255,.10); }
    .tc-menu-item:active{ transform: translateY(1px); }
    .tc-menu-item:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(0,0,0,.12), 0 0 0 6px var(--a1);
      border-radius: 0.6rem;
      background: rgba(255,255,255,.08);
    }
    #worldMenu .tc-world-item{
      color: var(--text);
      transition: background-color .15s ease, transform .05s ease;
    }
    #worldMenu .tc-world-item:hover{ background: rgba(255,255,255,.10); }
    #worldMenu .tc-world-item:active{ transform: translateY(1px); }
    #portalMenu,
    #worldMenu{
      z-index: var(--z-topbar-menu);
    }
    .account-nav-link{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem;
      padding: .55rem .75rem;
      border-radius: .8rem;
      color: var(--text);
    }
    .account-nav-link:hover{ background: rgba(255,255,255,.08); }
    .account-nav-link.is-active{
      background: linear-gradient(135deg, rgba(255,255,255,.24), rgba(255,255,255,.08));
      border: 1px solid var(--stroke);
    }
    .setting-row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .setting-control{
      min-width: 180px;
      text-align: right;
    }
    .setting-control input,
    .setting-control select{
      width: 100%;
      text-align: left;
    }
    .setting-toggle{
      min-width: 120px;
    }
    .overview-card{
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .overview-content{
      display: block;
    }
    .overview-skeleton{
      display: none;
    }
    .overview-card.is-loading .overview-content{
      display: none;
    }
    .overview-card.is-loading .overview-skeleton{
      display: block;
    }
    .overview-skeleton .skeleton-line{
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,255,255,0.25), rgba(255,255,255,0.55), rgba(255,255,255,0.25));
      background-size: 180% 100%;
      animation: skeletonShift 1.1s ease-in-out infinite;
    }
    .overview-skeleton .skeleton-pill{
      height: 18px;
      width: 86px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.25);
    }
    @keyframes skeletonShift{
      0%{ background-position: 100% 0; }
      100%{ background-position: 0 0; }
    }
    .overview-card:hover{
      transform: translateY(-1px);
      box-shadow: 0 26px 60px rgba(0,0,0,0.16);
      border-color: rgba(0,0,0,0.18);
    }
    .overview-card:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(0,0,0,.12), 0 0 0 6px var(--a1);
    }
    .overview-head{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
    }
    .overview-label{
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .overview-icon{
      width: 16px;
      height: 16px;
      color: var(--muted);
    }
    .overview-pill{
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.35);
      font-size: 11px;
      font-weight: 600;
      padding: .2rem .55rem;
      color: var(--text);
      white-space: nowrap;
    }
    .overview-pill.is-warning{
      color: #8a5a1a;
      border-color: rgba(138,90,26,0.35);
      background: rgba(255,240,220,0.7);
    }
    .overview-pill.is-error{
      color: #b42318;
      border-color: rgba(180,35,24,0.35);
      background: rgba(255,220,220,0.7);
    }
    #section-preferences .tc-pref-row{
      position: relative;
      z-index: 0;
    }
    #section-preferences .tc-pref-row.is-open{
      z-index: 50;
    }
    #section-preferences .tc-pref-menu{
      position: absolute;
      z-index: 60;
    }
    #section-preferences .setting-control .tc-btn{
      display: inline-flex;
      align-items: center;
      gap: .4rem;
    }
    #section-preferences .tc-pref-menu .tc-menu-item[data-selected="1"]{
      font-weight: 600;
    }
    #section-preferences .tc-pref-menu .tc-menu-item[data-selected="1"]::after{
      content: "\2713";
      float: right;
      color: var(--text);
    }
    html[data-density="gon"] .tc-account-main .p-6{ padding: 1.25rem !important; }
    html[data-density="gon"] .tc-account-main .p-4{ padding: 0.85rem !important; }
    html[data-density="gon"] .tc-account-main .gap-6{ gap: 1rem !important; }
    html[data-density="gon"] .tc-account-main .gap-4{ gap: 0.75rem !important; }
    html[data-density="gon"] .tc-account-main .px-4{ padding-left: 0.85rem !important; padding-right: 0.85rem !important; }
    html[data-density="gon"] .tc-account-main .px-3{ padding-left: 0.6rem !important; padding-right: 0.6rem !important; }
    html[data-density="gon"] .tc-account-main .py-3{ padding-top: 0.6rem !important; padding-bottom: 0.6rem !important; }
    html[data-density="gon"] .tc-account-main .py-2{ padding-top: 0.45rem !important; padding-bottom: 0.45rem !important; }
    html[data-density="thoang"] .tc-account-main .p-6{ padding: 1.85rem !important; }
    html[data-density="thoang"] .tc-account-main .p-4{ padding: 1.2rem !important; }
    html[data-density="thoang"] .tc-account-main .gap-6{ gap: 1.65rem !important; }
    html[data-density="thoang"] .tc-account-main .gap-4{ gap: 1.2rem !important; }
    html[data-density="thoang"] .tc-account-main .px-4{ padding-left: 1.2rem !important; padding-right: 1.2rem !important; }
    html[data-density="thoang"] .tc-account-main .px-3{ padding-left: 0.9rem !important; padding-right: 0.9rem !important; }
    html[data-density="thoang"] .tc-account-main .py-3{ padding-top: 0.95rem !important; padding-bottom: 0.95rem !important; }
    html[data-density="thoang"] .tc-account-main .py-2{ padding-top: 0.7rem !important; padding-bottom: 0.7rem !important; }
    @media (prefers-reduced-motion: reduce){
      .overview-card{ transition: none; }
      .overview-card:hover{ transform: none; }
      .overview-skeleton .skeleton-line{ animation: none; }
    }
      .account-rail{
        position: sticky;
        top: 96px;
      }
      @media (max-width: 520px) {
        .tc-topbar > .max-w-6xl {
          flex-wrap: wrap;
          row-gap: 8px;
          column-gap: 8px;
        }
        .tc-topbar > .max-w-6xl > :nth-child(1) {
          order: 1;
          min-width: 0;
        }
        .tc-topbar > .max-w-6xl > :nth-child(2) {
          order: 3;
          flex: 1 1 100%;
          min-width: 0;
        }
        .tc-topbar > .max-w-6xl > :nth-child(3) {
          order: 2;
          margin-left: auto;
        }
        .tc-topbar #portalSwitcher,
        .tc-topbar #portalBtn {
          width: 100%;
          max-width: 100%;
        }
        .tc-topbar [data-i18n="topbar.slogan"] {
          display: none;
        }
        .tc-topbar .tc-brand {
          max-width: 160px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }
        #topbarAuthSlot #userName {
          display: none;
        }
        .tc-topbar a,
        .tc-topbar button {
          min-height: 40px;
        }
        .account-rail{
          position: static;
        }
        .account-rail .account-nav{
          display: flex;
          gap: 8px;
          overflow-x: auto;
          padding-bottom: 6px;
          scroll-snap-type: x mandatory;
        }
        .account-rail .account-nav::-webkit-scrollbar{
          height: 4px;
        }
        .account-rail .account-nav::-webkit-scrollbar-thumb{
          background: rgba(0,0,0,.18);
          border-radius: 999px;
        }
        .account-rail .account-nav-link{
          flex: 0 0 auto;
          white-space: nowrap;
          scroll-snap-align: start;
        }
      }
    </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html, body, button, input, select, textarea {
      font-family: "Inter", "Noto Sans", system-ui, -apple-system, "Segoe UI", sans-serif;
    }
  </style></head>
<body class="font-sans">
  <header class="tc-topbar relative">
    <div class="max-w-6xl mx-auto px-4 py-3 flex flex-wrap items-center gap-3 sm:flex-nowrap sm:gap-4 md:grid md:grid-cols-[1fr_auto_1fr] md:items-center">
      <div class="flex items-center gap-3 min-w-0 flex-1 order-1 sm:order-none sm:flex-none md:justify-self-start tc-topbar__left">
        <a href="./index.html" class="flex items-center gap-3 min-w-0">
          <span class="h-11 w-11 md:h-12 md:w-12 rounded-xl shrink-0 flex items-center justify-center bg-white/5 ring-1 ring-white/10">
            <picture>
              <source srcset="./assets/spacecolors-mark.svg" type="image/svg+xml">
              <img
                src="./assets/spacecolors-mark-128.png"
                srcset="./assets/spacecolors-mark-128.png 1x, ./assets/spacecolors-mark-256.png 2x"
                class="h-full w-full object-contain select-none"
                alt="SpaceColors"
                decoding="async"
                loading="eager"
              />
            </picture>
          </span>
          <span class="min-w-0 flex flex-col justify-center leading-tight">
            <span class="tc-brand text-base md:text-lg whitespace-nowrap" data-i18n="topbar.brand">SpaceColors</span>
            <span class="tc-muted text-[11px] md:text-xs truncate max-w-[240px] md:max-w-[360px] hidden sm:block" data-i18n="topbar.slogan">Một chạm mở không gian màu vô hạn</span>
          </span>
        </a>
      </div>
      <div class="order-3 w-full flex items-center justify-center gap-3 sm:order-none sm:w-auto sm:flex-1 md:justify-self-center tc-topbar__center">
        <div class="relative" id="portalSwitcher">
          <button id="portalBtn"
            class="tc-chip tc-btn flex items-center gap-2 px-3 py-2 text-sm font-semibold w-[210px] justify-between"
            aria-expanded="false" aria-haspopup="menu" aria-controls="portalMenu">
            Chọn Thế giới
          </button>
          <div id="portalMenu" data-open="0" role="menu" class="absolute left-1/2 -translate-x-1/2 mt-2 w-56 rounded-lg backdrop-blur-md shadow-xl p-1 text-sm tc-chip">
            <a class="tc-menu-item block w-full text-left px-3 py-2 rounded-md" href="./worlds/threadcolor.html" role="menuitem">Thế giới màu thêu</a>
            <a class="tc-menu-item block w-full text-left px-3 py-2 rounded-md" href="./worlds/gradient.html" role="menuitem">Thế giới Dải chuyển màu</a>
            <a class="tc-menu-item block w-full text-left px-3 py-2 rounded-md" href="./worlds/palette.html" role="menuitem">Thế giới Bảng phối màu</a>
            <a class="tc-menu-item block w-full text-left px-3 py-2 rounded-md" href="./worlds/printcolor.html" role="menuitem">Thế giới Màu in (CMYK)</a>
            <a class="tc-menu-item block w-full text-left px-3 py-2 rounded-md" href="./worlds/library.html" role="menuitem">Thế giới Thư viện Tài sản Màu</a>
            <a class="tc-menu-item block w-full text-left px-3 py-2 rounded-md" href="./worlds/paintfabric.html" role="menuitem">Thế giới màu Sơn&Vải</a>
            <a class="tc-menu-item block w-full text-left px-3 py-2 rounded-md" href="./worlds/imagecolor.html" role="menuitem">Thế giới Màu từ Ảnh</a>
            <a class="tc-menu-item block w-full text-left px-3 py-2 rounded-md" href="./worlds/community.html" role="menuitem">Thế giới Chia sẻ + Remix</a>
          </div>
        </div>
        <div class="relative" id="worldSwitcher">
          <button id="worldBtn"
            class="tc-chip tc-btn flex items-center gap-2 px-3 py-2 text-sm font-semibold w-[150px] justify-between"
            aria-expanded="false" aria-haspopup="menu" aria-controls="worldMenu" data-i18n-attr="aria-label:topbar.tones.label">
            <span class="flex items-center gap-2">
              <span class="tc-dot" aria-hidden="true"></span>
              <span id="worldLabel">Origami</span>
            </span>
            <span aria-hidden="true">▾</span>
          </button>
          <div id="worldMenu" data-open="0" role="menu" class="absolute right-0 mt-2 w-48 rounded-lg backdrop-blur-md shadow-xl p-1 text-sm tc-chip">
            <button class="tc-world-item w-full text-left px-3 py-2 rounded-md" data-world="nebula" role="menuitem">Tinh vân</button>
            <button class="tc-world-item w-full text-left px-3 py-2 rounded-md" data-world="ocean" role="menuitem">Đại dương</button>
            <button class="tc-world-item w-full text-left px-3 py-2 rounded-md" data-world="ink" role="menuitem">Mực tàu</button>
            <button class="tc-world-item w-full text-left px-3 py-2 rounded-md" data-world="origami" role="menuitem">Origami</button>
            <button class="tc-world-item w-full text-left px-3 py-2 rounded-md" data-world="arcade" role="menuitem">Arcade</button>
            <button class="tc-world-item w-full text-left px-3 py-2 rounded-md" data-world="dunes" role="menuitem">Đồi cát</button>
            <button class="tc-world-item w-full text-left px-3 py-2 rounded-md" data-world="chrome" role="menuitem">Chrome</button>
            <button class="tc-world-item w-full text-left px-3 py-2 rounded-md" data-world="circuit" role="menuitem">Mạch điện</button>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-end gap-3 order-2 ml-auto sm:order-none sm:ml-0 md:justify-self-end tc-topbar__right">
        <div id="topbarAuthSlot" data-auth-slot="topbar" class="tc-auth-float flex items-center justify-end order-2 col-span-1 justify-self-end sm:order-none"></div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 pt-8 pb-16 tc-account-main">
    <div class="flex flex-col gap-6 lg:flex-row">
      <aside class="lg:w-60">
        <div class="tc-card p-4 space-y-4">
          <a id="returnLink" class="tc-btn tc-chip w-full justify-center text-sm font-semibold hidden" href="#">? Quay lại</a>
          <div>
            <div class="text-xs uppercase tracking-wide tc-muted">Tài khoản</div>
            <nav class="account-nav mt-2 space-y-1">
              <a class="account-nav-link" href="#section-overview">Tổng quan</a>
              <a class="account-nav-link" href="#section-profile">Hồ sơ</a>
              <a class="account-nav-link" href="#section-security">Bảo mật</a>
            </nav>
          </div>
          <div>
            <div class="text-xs uppercase tracking-wide tc-muted">Tùy biến</div>
            <nav class="account-nav mt-2 space-y-1">
              <a class="account-nav-link" href="#section-preferences">Tùy biến</a>
            </nav>
          </div>
          <div>
            <div class="text-xs uppercase tracking-wide tc-muted">Dữ liệu & đồng bộ</div>
            <nav class="account-nav mt-2 space-y-1">
              <a class="account-nav-link" href="#section-data">Dữ liệu & đồng bộ</a>
              <a class="account-nav-link" href="#section-privacy">Quyền riêng tư</a>
            </nav>
          </div>
          <div>
            <div class="text-xs uppercase tracking-wide tc-muted">Hệ sinh thái</div>
            <nav class="account-nav mt-2 space-y-1">
              <a class="account-nav-link opacity-60 cursor-not-allowed" href="#section-plan" aria-disabled="true">Gói dịch vụ (sắp ra mắt)</a>
              <a class="account-nav-link opacity-60 cursor-not-allowed" href="#section-team" aria-disabled="true">Không gian làm việc / Nhóm (sắp ra mắt)</a>
            </nav>
          </div>
          <div>
            <div class="text-xs uppercase tracking-wide tc-muted">Hỗ trợ</div>
            <nav class="account-nav mt-2 space-y-1">
              <a class="account-nav-link" href="#section-support">Hỗ trợ & phản hồi</a>
              <a class="account-nav-link" href="#section-logout">Đăng xuất</a>
            </nav>
          </div>
        </div>
      </aside>

      <section class="flex-1 space-y-6">
        <div id="accountAuthGate" class="tc-card p-6 hidden" data-section="auth-gate">
          <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div>
              <div class="text-xs uppercase tracking-wide tc-muted">Quản lý tài khoản</div>
              <div class="text-lg font-semibold mt-2">Đăng nhập để đồng bộ hồ sơ</div>
              <div class="tc-muted text-sm mt-1">Mở khóa sao lưu, lịch sử và dữ liệu đã lưu.</div>
            </div>
            <button id="btnAccountLogin" data-action="login" class="tc-btn tc-btn-primary px-5 py-2 text-sm font-semibold">Đăng nhập</button>
          </div>
        </div>
        <div id="section-overview" class="tc-card p-6">
          <h2 class="text-xl font-semibold">Tổng quan</h2>
          <div class="mt-4 grid gap-4 md:grid-cols-2">
            <div class="tc-card p-4 overview-card is-loading" data-overview-card="1" data-overview-index="0" tabindex="0">
              <div class="overview-content">
                <div class="overview-head">
                  <div class="overview-label">
                    <svg class="overview-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" aria-hidden="true">
                      <path d="M12 3l8 8-8 8-8-8 8-8z"></path>
                      <circle cx="12" cy="12" r="2.2"></circle>
                    </svg>
                    <span class="text-sm tc-muted">Trạng thái tài khoản</span>
                  </div>
                  <span class="overview-pill" data-role="pill">Đang kết nối</span>
                </div>
                <div class="mt-3 text-lg font-semibold leading-tight" data-role="value">Ổn định</div>
                <div class="text-xs tc-muted mt-1" data-role="sub">Phiên hoạt động liên tục</div>
              </div>
              <div class="overview-skeleton" aria-hidden="true">
                <div class="overview-head">
                  <div class="overview-label">
                    <span class="skeleton-line" style="width: 120px;"></span>
                  </div>
                  <span class="skeleton-pill"></span>
                </div>
                <div class="mt-3 skeleton-line" style="width: 70%; height: 14px;"></div>
                <div class="mt-2 skeleton-line" style="width: 55%;"></div>
              </div>
            </div>
            <div class="tc-card p-4 overview-card is-loading" data-overview-card="1" data-overview-index="1" tabindex="0">
              <div class="overview-content">
                <div class="overview-head">
                  <div class="overview-label">
                    <svg class="overview-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" aria-hidden="true">
                      <path d="M4 7h16M4 12h16M4 17h10"></path>
                    </svg>
                    <span class="text-sm tc-muted">Dữ liệu</span>
                  </div>
                  <span class="overview-pill" data-role="pill">Đang đồng bộ</span>
                </div>
                <div class="mt-3 text-lg font-semibold leading-tight" data-role="value">12 bản lưu</div>
                <div class="text-xs tc-muted mt-1" data-role="sub">3 dự án đang theo dõi</div>
              </div>
              <div class="overview-skeleton" aria-hidden="true">
                <div class="overview-head">
                  <div class="overview-label">
                    <span class="skeleton-line" style="width: 90px;"></span>
                  </div>
                  <span class="skeleton-pill"></span>
                </div>
                <div class="mt-3 skeleton-line" style="width: 62%; height: 14px;"></div>
                <div class="mt-2 skeleton-line" style="width: 50%;"></div>
              </div>
            </div>
            <div class="tc-card p-4 overview-card is-loading" data-overview-card="1" data-overview-index="2" tabindex="0">
              <div class="overview-content">
                <div class="overview-head">
                  <div class="overview-label">
                    <svg class="overview-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" aria-hidden="true">
                      <path d="M4 12a8 8 0 0 1 16 0"></path>
                      <path d="M12 4v6l4 2"></path>
                    </svg>
                    <span class="text-sm tc-muted">Đồng bộ</span>
                  </div>
                  <span class="overview-pill" data-role="pill">Đang bật</span>
                </div>
                <div class="mt-3 text-lg font-semibold leading-tight" data-role="value">Đang bật</div>
                <div class="text-xs tc-muted mt-1" data-role="sub">Tốc độ tiêu chuẩn</div>
              </div>
              <div class="overview-skeleton" aria-hidden="true">
                <div class="overview-head">
                  <div class="overview-label">
                    <span class="skeleton-line" style="width: 90px;"></span>
                  </div>
                  <span class="skeleton-pill"></span>
                </div>
                <div class="mt-3 skeleton-line" style="width: 58%; height: 14px;"></div>
                <div class="mt-2 skeleton-line" style="width: 46%;"></div>
              </div>
            </div>
            <div class="tc-card p-4 overview-card is-loading" data-overview-card="1" data-overview-index="3" tabindex="0">
              <div class="overview-content">
                <div class="overview-head">
                  <div class="overview-label">
                    <svg class="overview-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" aria-hidden="true">
                      <path d="M12 6v6l4 2"></path>
                      <circle cx="12" cy="12" r="8"></circle>
                    </svg>
                    <span class="text-sm tc-muted">Hoạt động gần đây</span>
                  </div>
                  <span class="overview-pill" data-role="pill">Mới</span>
                </div>
                <div class="mt-3 text-lg font-semibold leading-tight" data-role="value">3 thao tác</div>
                <div class="text-xs tc-muted mt-1" data-role="sub">Cập nhật hôm nay</div>
              </div>
              <div class="overview-skeleton" aria-hidden="true">
                <div class="overview-head">
                  <div class="overview-label">
                    <span class="skeleton-line" style="width: 140px;"></span>
                  </div>
                  <span class="skeleton-pill"></span>
                </div>
                <div class="mt-3 skeleton-line" style="width: 64%; height: 14px;"></div>
                <div class="mt-2 skeleton-line" style="width: 42%;"></div>
              </div>
            </div>
          </div>
        </div>

        <div id="section-profile" class="tc-card p-6" data-section="profile">
          <h2 class="text-xl font-semibold">Hồ sơ</h2>
          <div class="mt-2 tc-muted text-sm">Cập nhật thông tin hiển thị trong hệ sinh thái.</div>
          <div class="mt-4 space-y-3">
            <div class="tc-card p-4 setting-row" data-setting="display-name">
              <div>
                <div class="text-sm tc-muted">Tên hiển thị</div>
                <div class="text-xs tc-muted">Tên hiển thị trên menu tài khoản.</div>
              </div>
              <div class="setting-control">
                <input id="profileDisplayName" data-field="profile.displayName" type="text" class="tc-chip px-3 py-2 text-sm font-semibold w-full" placeholder="Ví dụ: SpaceColors Studio">
              </div>
            </div>
            <div class="tc-card p-4 setting-row" data-setting="photo-url">
              <div>
                <div class="text-sm tc-muted">Ảnh (URL)</div>
                <div class="text-xs tc-muted">Link ảnh đại diện công khai.</div>
              </div>
              <div class="setting-control">
                <input id="profilePhotoUrl" data-field="profile.photoURL" type="url" class="tc-chip px-3 py-2 text-sm font-semibold w-full" placeholder="https://">
              </div>
            </div>
            <div class="tc-card p-4 setting-row" data-setting="org-unit">
              <div>
                <div class="text-sm tc-muted">Đơn vị / Nhóm</div>
                <div class="text-xs tc-muted">Dùng cho vị trí làm việc.</div>
              </div>
              <div class="setting-control">
                <input id="profileOrgUnit" data-field="profile.orgUnit" type="text" class="tc-chip px-3 py-2 text-sm font-semibold w-full" placeholder="Ví dụ: Xưởng Thêu 01">
              </div>
            </div>
            <div class="tc-card p-4 setting-row" data-setting="goal">
              <div>
                <div class="text-sm tc-muted">Mục tiêu</div>
                <div class="text-xs tc-muted">Ghi ngắn gọn nhu cầu chính.</div>
              </div>
              <div class="setting-control">
                <input id="profileGoal" data-field="profile.goal" type="text" class="tc-chip px-3 py-2 text-sm font-semibold w-full" placeholder="Ví dụ: Tương thích màu chính xác">
              </div>
            </div>
          </div>
          <div class="mt-4 flex flex-wrap items-center gap-3">
            <button id="btnProfileSave" data-action="profile-save" class="tc-btn tc-btn-primary px-4 py-2 text-sm font-semibold">Lưu hồ sơ</button>
            <div id="profileStatus" data-role="profile-status" class="text-sm tc-muted"></div>
          </div>
        </div>

        <div id="section-security" class="tc-card p-6" data-section="security">
          <h2 class="text-xl font-semibold">Bảo mật</h2>
          <div class="mt-4 space-y-3">
            <div class="tc-card p-4 setting-row" data-setting="password">
              <div>
                <div class="text-sm tc-muted">Đổi mật khẩu</div>
                <div class="text-xs tc-muted">Gửi liên kết đặt lại qua email.</div>
              </div>
              <div class="setting-control">
                <button id="btnPasswordAction" data-action="password-reset" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Cập nhật</button>
              </div>
            </div>
            <div class="tc-card p-4 setting-row" data-setting="sessions">
              <div>
                <div class="text-sm tc-muted">Phiên đăng nhập</div>
                <div class="text-xs tc-muted">Thu hồi tất cả phiên đã mở.</div>
              </div>
              <div class="setting-control">
                <button id="btnSignOutAllDevices" data-action="revoke-sessions" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Đăng xuất mọi thiết bị</button>
              </div>
            </div>
          </div>
        </div>

        <div id="section-preferences" class="tc-card p-6" data-section="preferences">
          <h2 class="text-xl font-semibold">Tùy biến</h2>
          <div class="mt-4 space-y-3">
            <div class="tc-card p-4 setting-row tc-pref-row" data-setting="world">
              <div>
                <div class="text-sm tc-muted">Sắc thái mặc định</div>
                <div class="text-xs tc-muted">Chọn sắc thái mặc định.</div>
              </div>
              <div class="setting-control">
                <div class="relative">
                  <button id="btnPrefWorld" data-action="pref-world" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold flex items-center gap-2" aria-expanded="false" aria-haspopup="menu" aria-controls="prefWorldMenu">
                    <span id="prefWorldLabel">Origami</span>
                    <span aria-hidden="true">▾</span>
                  </button>
                  <div id="prefWorldMenu" data-open="0" role="menu" class="tc-pref-menu absolute right-0 mt-2 w-48 rounded-lg backdrop-blur-md shadow-xl p-1 text-sm tc-chip hidden">
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md" data-value="nebula" role="menuitem">Tinh vân</button>
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md" data-value="ocean" role="menuitem">Đại dương</button>
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md" data-value="ink" role="menuitem">Mực tàu</button>
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md" data-value="origami" role="menuitem">Origami</button>
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md" data-value="arcade" role="menuitem">Arcade</button>
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md" data-value="dunes" role="menuitem">Đồi cát</button>
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md" data-value="chrome" role="menuitem">Chrome</button>
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md" data-value="circuit" role="menuitem">Mạch điện</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="tc-card p-4 setting-row tc-pref-row" data-setting="language">
              <div>
                <div class="text-sm tc-muted">Ngôn ngữ</div>
                <div class="text-xs tc-muted">Dùng ngôn ngữ ưa thích.</div>
              </div>
              <div class="setting-control">
                <div class="relative">
                  <button id="btnPrefLanguage" data-action="pref-language" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold flex items-center gap-2" aria-expanded="false" aria-haspopup="menu" aria-controls="prefLanguageMenu">
                    <span id="prefLanguageLabel">Tiếng Việt</span>
                    <span aria-hidden="true">▾</span>
                  </button>
                  <div id="prefLanguageMenu" data-open="0" role="menu" class="tc-pref-menu absolute right-0 mt-2 w-48 rounded-lg backdrop-blur-md shadow-xl p-1 text-sm tc-chip hidden">
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md" data-value="vi" role="menuitem">Tiếng Việt</button>
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md opacity-60 cursor-not-allowed" data-value="en" role="menuitem" aria-disabled="true" disabled>English (sắp ra mắt)</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="tc-card p-4 setting-row tc-pref-row" data-setting="density">
              <div>
                <div class="text-sm tc-muted">Mật độ UI</div>
                <div class="text-xs tc-muted">Điều chỉnh độ thoáng giao diện.</div>
              </div>
              <div class="setting-control">
                <div class="relative">
                  <button id="btnPrefDensity" data-action="pref-density" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold flex items-center gap-2" aria-expanded="false" aria-haspopup="menu" aria-controls="prefDensityMenu">
                    <span id="prefDensityLabel">Chuẩn</span>
                    <span aria-hidden="true">▾</span>
                  </button>
                  <div id="prefDensityMenu" data-open="0" role="menu" class="tc-pref-menu absolute right-0 mt-2 w-48 rounded-lg backdrop-blur-md shadow-xl p-1 text-sm tc-chip hidden">
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md" data-value="chuan" role="menuitem">Chuẩn</button>
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md" data-value="gon" role="menuitem">Gọn</button>
                    <button class="tc-menu-item w-full text-left px-3 py-2 rounded-md" data-value="thoang" role="menuitem">Thoáng</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="tc-card p-4 setting-row tc-pref-row" data-setting="shortcuts">
              <div>
                <div class="text-sm tc-muted">Phím tắt</div>
                <div class="text-xs tc-muted">Bật/tắt phím tắt nổi.</div>
              </div>
              <div class="setting-control setting-toggle flex flex-col items-end gap-2">
                <button id="btnPrefShortcutsToggle" data-toggle="shortcuts" aria-pressed="true" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Đang bật</button>
                <div id="shortcutsListWrap" class="hidden">
                  <button id="btnShortcutsList" data-action="shortcuts-list" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Xem danh sách phím tắt</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="section-data" class="tc-card p-6" data-section="data">
          <h2 class="text-xl font-semibold">Dữ liệu & đồng bộ</h2>
          <div class="mt-4 space-y-3">
            <div class="tc-card p-4 setting-row" data-setting="export">
              <div>
                <div class="text-sm tc-muted">Xuất dữ liệu</div>
                <div class="text-xs tc-muted">Tải về JSON hoặc CSV.</div>
              </div>
              <div class="setting-control flex flex-wrap gap-2 justify-end">
                <button id="btnExportJson" data-action="export-json" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Xuất JSON</button>
                <button id="btnExportCsv" data-action="export-csv" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Xuất CSV</button>
              </div>
            </div>
            <div class="tc-card p-4 setting-row" data-setting="import">
              <div>
                <div class="text-sm tc-muted">Nhập dữ liệu</div>
                <div class="text-xs tc-muted">Nhập tệp từ bộ sưu tập khác.</div>
              </div>
              <div class="setting-control">
                <button id="btnImportFile" data-action="import-file" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Nhập tệp</button>
              </div>
            </div>
            <div class="tc-card p-4 setting-row" data-setting="backup">
              <div>
                <div class="text-sm tc-muted">Sao lưu / Khôi phục</div>
                <div class="text-xs tc-muted">Lưu nhanh hoặc khôi phục từ bản sao.</div>
              </div>
              <div class="setting-control flex flex-wrap gap-2 justify-end">
                <button id="btnBackupCreate" data-action="backup-create" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Tạo sao lưu</button>
                <button id="btnBackupRestore" data-action="backup-restore" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Khôi phục</button>
              </div>
            </div>
            <div class="tc-card p-4 setting-row" data-setting="sync">
              <div>
                <div class="text-sm tc-muted">Đồng bộ</div>
                <div class="text-xs tc-muted">Bật tỷ lệ đồng bộ với tài khoản.</div>
              </div>
              <div class="setting-control setting-toggle">
                <button id="btnSyncToggle" data-toggle="sync" aria-pressed="true" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Đang bật</button>
              </div>
            </div>
          </div>
          <input id="accountImportInput" data-role="import-input" type="file" accept=".json,.csv" class="hidden">
        </div>
        <div id="section-privacy" class="tc-card p-6" data-section="privacy">
          <h2 class="text-xl font-semibold">Quyền riêng tư</h2>
          <div class="mt-4 space-y-3">
            <div class="tc-card p-4 setting-row" data-setting="telemetry">
              <div>
                <div class="text-sm tc-muted">Đóng góp dữ liệu</div>
                <div class="text-xs tc-muted">Chia sẻ nhẹ để cải thiện sản phẩm.</div>
              </div>
              <div class="setting-control setting-toggle">
                <button id="btnPrivacyTelemetryToggle" data-toggle="telemetry" aria-pressed="true" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Đang bật</button>
              </div>
            </div>
            <div class="tc-card p-4 setting-row" data-setting="read-only">
              <div>
                <div class="text-sm tc-muted">Chia sẻ chế độ xem</div>
                <div class="text-xs tc-muted">Cho phép người khác xem mục công khai.</div>
              </div>
              <div class="setting-control setting-toggle">
                <button id="btnPrivacyReadonlyToggle" data-toggle="read-only" aria-pressed="false" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Đang tắt</button>
              </div>
            </div>
            <div class="tc-card p-4 setting-row" data-setting="anonymous">
              <div>
                <div class="text-sm tc-muted">Chế độ ẩn danh</div>
                <div class="text-xs tc-muted">Ẩn tên hiển thị trong bảng xếp hạng.</div>
              </div>
              <div class="setting-control setting-toggle">
                <button id="btnPrivacyAnonymousToggle" data-toggle="anonymous" aria-pressed="false" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Không kích hoạt</button>
              </div>
            </div>
          </div>
        </div>

        <div id="section-plan" class="tc-card p-6">
          <h2 class="text-xl font-semibold">Gói dịch vụ (sắp ra mắt)</h2>
          <p class="mt-2 tc-muted">Chuẩn bị ra mắt gói cá nhân và doanh nghiệp.</p>
        </div>

        <div id="section-team" class="tc-card p-6">
          <h2 class="text-xl font-semibold">Không gian làm việc / Nhóm (sắp ra mắt)</h2>
          <p class="mt-2 tc-muted">Tổ chức nhóm, quy trình và phân quyền sẽ được mở sau.</p>
        </div>

        <div id="section-support" class="tc-card p-6" data-section="support">
          <h2 class="text-xl font-semibold">Hỗ trợ & phản hồi</h2>
          <div class="mt-4 space-y-3">
            <div class="tc-card p-4 setting-row" data-setting="feedback">
              <div>
                <div class="text-sm tc-muted">Gửi phản hồi</div>
                <div class="text-xs tc-muted">Nói nhanh nhu cầu hoặc lỗi gặp phải.</div>
              </div>
              <div class="setting-control">
                <button id="btnSupportFeedback" data-action="support-feedback" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Gửi phản hồi</button>
              </div>
            </div>
            <div class="tc-card p-4 setting-row" data-setting="contact">
              <div>
                <div class="text-sm tc-muted">Liên hệ hỗ trợ</div>
                <div class="text-xs tc-muted">Ưu tiên những vấn đề khẩn cấp.</div>
              </div>
              <div class="setting-control">
                <button id="btnSupportContact" data-action="support-contact" class="tc-btn tc-chip px-3 py-2 text-sm font-semibold">Liên hệ ngay</button>
              </div>
            </div>
          </div>
        </div>

        <div id="section-logout" class="tc-card p-6" data-section="logout">
          <h2 class="text-xl font-semibold">Đăng xuất</h2>
          <div class="mt-4 space-y-3">
            <div class="tc-card p-4 setting-row" data-setting="logout">
              <div>
                <div class="text-sm tc-muted">Thoát tài khoản</div>
                <div class="text-xs tc-muted">Kết thúc phiên hiện tại trên thiết bị này.</div>
              </div>
              <div class="setting-control">
                <button id="btnLogout" data-action="logout" class="tc-btn tc-btn-primary px-4 py-2 text-sm font-semibold">Thoát tài khoản</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <aside class="lg:w-72">
        <div class="account-rail tc-card p-5 space-y-4">
          <div>
            <div class="text-xs uppercase tracking-wide tc-muted">Hành động nhanh</div>
            <div class="mt-2 flex flex-col gap-2">
              <button id="btnQuickSyncNow" data-action="sync-now" class="tc-btn tc-btn-primary px-4 py-2 text-sm font-semibold">Đồng bộ ngay</button>
              <button id="btnQuickSyncToggle" data-action="sync-toggle-quick" class="tc-btn tc-chip px-4 py-2 text-sm font-semibold">Tắt đồng bộ</button>
              <button id="btnQuickRetry" data-action="sync-retry" class="tc-btn tc-chip px-4 py-2 text-sm font-semibold">Thử lại kết nối</button>
            </div>
          </div>
          <div class="tc-card p-4">
            <div class="text-sm tc-muted">Trạng thái</div>
            <div class="mt-2 text-sm font-semibold">2/8 Thế giới sắn sàng</div>
            <div class="mt-1 text-sm tc-muted">Sắc thái đang dùng: Origami</div>
            <div class="mt-1 text-sm tc-muted">Đồng bộ: Đang bật</div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <div id="toastContainer" data-role="toast-container" class="fixed bottom-6 right-6 z-[5000] flex flex-col gap-2"></div>

  <div id="confirmModal" data-role="confirm-modal" class="fixed inset-0 z-[4500] hidden items-center justify-center bg-black/30 p-4">
    <div class="tc-card w-full max-w-md p-6">
      <div class="text-xs uppercase tracking-wide tc-muted">Xác nhận</div>
      <div id="confirmTitle" data-role="confirm-title" class="text-lg font-semibold mt-2">Xác nhận thao tác</div>
      <div id="confirmMessage" data-role="confirm-message" class="tc-muted text-sm mt-2">Bạn có chắc muốn tiếp tục?</div>
      <div class="mt-4 flex flex-wrap justify-end gap-2">
        <button id="btnConfirmCancel" data-action="confirm-cancel" class="tc-btn tc-chip px-4 py-2 text-sm font-semibold">Huỷ</button>
        <button id="btnConfirmOk" data-action="confirm-ok" class="tc-btn tc-btn-primary px-4 py-2 text-sm font-semibold">Xác nhận</button>
      </div>
    </div>
  </div>

  <div id="shortcutsModal" data-role="shortcuts-modal" class="fixed inset-0 z-[4600] hidden items-center justify-center bg-black/40 p-4">
    <div class="tc-card w-full max-w-lg p-6">
      <div class="text-xs uppercase tracking-wide tc-muted">Phím tắt</div>
      <div class="text-lg font-semibold mt-2">Danh sách phím tắt</div>
      <div class="tc-muted text-sm mt-1">Danh sách này được trích từ mã hiện tại.</div>
      <div id="shortcutsList" class="mt-4 space-y-3"></div>
      <div class="mt-5 flex justify-end">
        <button id="btnShortcutsClose" data-action="shortcuts-close" class="tc-btn tc-btn-primary px-4 py-2 text-sm font-semibold">Đóng</button>
      </div>
    </div>
  </div>

  <script src="./i18n.js"></script>
  <script type="module" src="./auth.js"></script>
  <script type="module" src="./account.js"></script>
  
  
  <script>
    (() => {
      const prefWorldBtn = document.getElementById("btnPrefWorld");
      const prefWorldMenu = document.getElementById("prefWorldMenu");
      const prefWorldLabel = document.getElementById("prefWorldLabel");
      const prefLanguageBtn = document.getElementById("btnPrefLanguage");
      const prefLanguageMenu = document.getElementById("prefLanguageMenu");
      const prefLanguageLabel = document.getElementById("prefLanguageLabel");
      const prefDensityBtn = document.getElementById("btnPrefDensity");
      const prefDensityMenu = document.getElementById("prefDensityMenu");
      const prefDensityLabel = document.getElementById("prefDensityLabel");
      const prefShortcutsBtn = document.getElementById("btnPrefShortcutsToggle");
      const shortcutsListWrap = document.getElementById("shortcutsListWrap");
      const shortcutsListBtn = document.getElementById("btnShortcutsList");
      const shortcutsModal = document.getElementById("shortcutsModal");
      const shortcutsList = document.getElementById("shortcutsList");
      const shortcutsClose = document.getElementById("btnShortcutsClose");
      const prefRows = Array.from(document.querySelectorAll("#section-preferences .tc-pref-row"));
      const toneOptions = [
        { key: "nebula", label: "Tinh v\u00e2n" },
        { key: "ocean", label: "\u0110\u1ea1i d\u01b0\u01a1ng" },
        { key: "ink", label: "M\u1ef1c t\u00e0u" },
        { key: "origami", label: "Origami" },
        { key: "arcade", label: "Arcade" },
        { key: "dunes", label: "\u0110\u1ed3i c\u00e1t" },
        { key: "chrome", label: "Chrome" },
        { key: "circuit", label: "M\u1ea1ch \u0111i\u1ec7n" }
      ];
      const toneLabels = toneOptions.reduce((acc, item) => {
        acc[item.key] = item.label;
        return acc;
      }, {});
      const defaultTone = "origami";
      const densityLabels = {
        chuan: "Chu\u1ea9n",
        gon: "G\u1ecdn",
        thoang: "Tho\u00e1ng"
      };
      const langLabels = {
        vi: "Ti\u1ebfng Vi\u1ec7t",
        en: "English"
      };
      const shortcutItems = [
        {
          key: "Escape",
          action: "\u0110\u00f3ng b\u1ea3ng ki\u1ec3m m\u00e0u (Inspector)",
          source: "script.js#L2281"
        },
        {
          key: "I",
          action: "M\u1edf c\u00f4ng c\u1ee5 l\u1ea5y m\u00e0u (EyeDropper)",
          source: "script.js#L2281"
        },
        {
          key: "Ctrl/Cmd + Shift + P",
          action: "M\u1edf c\u00f4ng c\u1ee5 l\u1ea5y m\u00e0u (EyeDropper)",
          source: "script.js#L2281"
        },
        {
          key: "Escape",
          action: "\u0110\u00f3ng menu s\u1eafc th\u00e1i \u1edf Topbar",
          source: "account.html#L1030"
        },
        {
          key: "Escape",
          action: "\u0110\u00f3ng menu portal/nh\u00f3m",
          source: "worlds/threadcolor.html#L1062, worlds/threadvault.html#L486, worlds/palette.html#L382"
        }
      ];
      const setRowOpen = (row, open) => {
        prefRows.forEach((item) => {
          item.classList.toggle("is-open", item === row && open);
        });
      };
      const closeMenus = () => {
        [prefWorldMenu, prefLanguageMenu, prefDensityMenu].forEach((menu) => {
          if (!menu) return;
          menu.dataset.open = "0";
          menu.classList.add("hidden");
        });
        [prefWorldBtn, prefLanguageBtn, prefDensityBtn].forEach((btn) => {
          if (!btn) return;
          btn.setAttribute("aria-expanded", "false");
        });
        setRowOpen(null, false);
      };
      const toggleMenu = (btn, menu) => {
        if (!btn || !menu) return;
        const open = menu.dataset.open !== "1";
        closeMenus();
        menu.dataset.open = open ? "1" : "0";
        menu.classList.toggle("hidden", !open);
        btn.setAttribute("aria-expanded", open ? "true" : "false");
        setRowOpen(btn.closest(".tc-pref-row"), open);
      };
      const applyDensity = (value, persist = true) => {
        const next = densityLabels[value] ? value : "chuan";
        document.documentElement.dataset.density = next;
        if (prefDensityLabel) prefDensityLabel.textContent = densityLabels[next];
        if (persist) {
          try { localStorage.setItem("tc_density", next); } catch (e) {}
        }
      };
      const applyLanguage = (value, persist = true) => {
        const next = langLabels[value] ? value : "vi";
        if (prefLanguageLabel) prefLanguageLabel.textContent = langLabels[next];
        if (persist) {
          try { localStorage.setItem("tc_lang", next); } catch (e) {}
        }
        if (window.tcI18n?.setLang) window.tcI18n.setLang(next);
      };
      const applyShortcuts = (enabled, persist = true) => {
        if (!prefShortcutsBtn) return;
        const next = !!enabled;
        prefShortcutsBtn.setAttribute("aria-pressed", next ? "true" : "false");
        prefShortcutsBtn.textContent = next ? "\u0110ang b\u1eadt" : "\u0110ang t\u1eaft";
        if (shortcutsListWrap) shortcutsListWrap.classList.toggle("hidden", !next);
        if (persist) {
          try { localStorage.setItem("tc_shortcuts", next ? "1" : "0"); } catch (e) {}
        }
      };
      const renderShortcuts = () => {
        if (!shortcutsList) return;
        shortcutsList.innerHTML = "";
        shortcutItems.forEach((item) => {
          const row = document.createElement("div");
          row.className = "tc-card p-4";
          row.innerHTML = `
            <div class="flex items-center justify-between gap-4">
              <div>
                <div class="text-sm font-semibold">${item.key}</div>
                <div class="text-xs tc-muted">${item.action || "Ph\u00edm: " + item.key + " \u2014 H\u00e0nh \u0111\u1ed9ng: (ch\u01b0a m\u00f4 t\u1ea3)"}</div>
              </div>
              <div class="text-[11px] tc-muted">${item.source}</div>
            </div>
          `;
          shortcutsList.appendChild(row);
        });
      };
      const openShortcutsModal = () => {
        if (!shortcutsModal) return;
        renderShortcuts();
        shortcutsModal.classList.remove("hidden");
        shortcutsModal.classList.add("flex");
      };
      const closeShortcutsModal = () => {
        if (!shortcutsModal) return;
        shortcutsModal.classList.add("hidden");
        shortcutsModal.classList.remove("flex");
      };
      const updateToneMenu = (selected) => {
        if (!prefWorldMenu) return;
        prefWorldMenu.querySelectorAll(".tc-menu-item").forEach((item) => {
          const value = item.getAttribute("data-value");
          const isSelected = value === selected;
          item.dataset.selected = isSelected ? "1" : "0";
          item.setAttribute("aria-checked", isSelected ? "true" : "false");
        });
      };
      const applyTone = (value, persist = true, syncWorld = true) => {
        const next = toneLabels[value] ? value : defaultTone;
        document.documentElement.dataset.tone = next;
        document.documentElement.dataset.world = next;
        if (prefWorldLabel) prefWorldLabel.textContent = toneLabels[next];
        updateToneMenu(next);
        if (persist) {
          try { localStorage.setItem("tc_tone", next); } catch (e) {}
        }
        if (syncWorld) {
          window.tcTheme?.applyWorld?.(next);
        } else if (window.tcTheme?.labels) {
          const topbarLabel = document.getElementById("worldLabel");
          if (topbarLabel) topbarLabel.textContent = window.tcTheme.labels[next] || "Origami";
        }
      };
      const syncFromStorage = () => {
        const storedTone = localStorage.getItem("tc_tone");
        const fallbackTone = window.tcTheme?.getWorld?.() || document.documentElement.dataset.world || defaultTone;
        applyTone(storedTone || fallbackTone, false, false);
        const storedDensity = localStorage.getItem("tc_density");
        applyDensity(storedDensity || "chuan", false);
        const storedLang = localStorage.getItem("tc_lang");
        applyLanguage(storedLang || "vi", false);
        const storedShortcuts = localStorage.getItem("tc_shortcuts");
        applyShortcuts(storedShortcuts !== "0", false);
      };

      prefWorldBtn?.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
        toggleMenu(prefWorldBtn, prefWorldMenu);
      }, true);
      prefLanguageBtn?.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
        toggleMenu(prefLanguageBtn, prefLanguageMenu);
      }, true);
      prefDensityBtn?.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
        toggleMenu(prefDensityBtn, prefDensityMenu);
      }, true);
      prefShortcutsBtn?.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
        const current = prefShortcutsBtn.getAttribute("aria-pressed") === "true";
        applyShortcuts(!current, true);
      }, true);
      shortcutsListBtn?.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        openShortcutsModal();
      });
      shortcutsClose?.addEventListener("click", (event) => {
        event.preventDefault();
        closeShortcutsModal();
      });
      shortcutsModal?.addEventListener("click", (event) => {
        if (event.target === shortcutsModal) closeShortcutsModal();
      });

      prefWorldMenu?.addEventListener("click", (event) => {
        const item = event.target.closest(".tc-menu-item");
        if (!item || item.disabled) return;
        const value = item.getAttribute("data-value");
        applyTone(value, true, true);
        closeMenus();
      });
      prefLanguageMenu?.addEventListener("click", (event) => {
        const item = event.target.closest(".tc-menu-item");
        if (!item || item.disabled) return;
        const value = item.getAttribute("data-value");
        applyLanguage(value, true);
        closeMenus();
      });
      prefDensityMenu?.addEventListener("click", (event) => {
        const item = event.target.closest(".tc-menu-item");
        if (!item || item.disabled) return;
        const value = item.getAttribute("data-value");
        applyDensity(value, true);
        closeMenus();
      });

      window.addEventListener("tc-world-changed", (event) => {
        const value = event.detail?.world;
        if (value) applyTone(value, true, false);
      });

      document.addEventListener("click", closeMenus);
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeMenus();
          closeShortcutsModal();
        }
      });

      syncFromStorage();
      let syncCount = 0;
      const syncTimer = setInterval(() => {
        syncFromStorage();
        syncCount += 1;
        if (syncCount > 6) clearInterval(syncTimer);
      }, 500);
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) syncFromStorage();
      });
    })();
  </script>
  <script>
    (() => {
      const returnLink = document.getElementById("returnLink");
      const params = new URLSearchParams(window.location.search);
      const ret = params.get("return");
      if (returnLink) {
        if (ret) {
          returnLink.href = ret;
          returnLink.classList.remove("hidden");
        }
      }
      const links = Array.from(document.querySelectorAll(".account-nav-link"));
      const sections = links
        .map(link => document.querySelector(link.getAttribute("href")))
        .filter(Boolean);
      if (!sections.length) return;
      const setActive = (id) => {
        links.forEach(link => {
          link.classList.toggle("is-active", link.getAttribute("href") === `#${id}`);
        });
      };
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) setActive(entry.target.id);
        });
      }, { rootMargin: "-30% 0px -55% 0px" });
      sections.forEach(section => observer.observe(section));
    })();
  </script>
  <script src="./scripts/topbar_behavior.js" defer></script>
</body>
</html>







